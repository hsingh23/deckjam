'use strict';
"use babel";

if (location.protocol != 'http:') {
  location.protocol = 'http:';
}
// if ('serviceWorker' in navigator) {
//   navigator.serviceWorker.register('service-worker.js');
// }
// removed service workers and fetch because quizlet does not do cors http://stackoverflow.com/a/34940074 
// no-cors mode won't send authorization header https://developer.mozilla.org/en-US/docs/Web/API/Request/mode
var lo = _;
// var app = angular.module('deckjam', ['ngMaterial'])
var app = angular.module('deckjam', ['ngMaterial', 'angulartics', 'angulartics.google.analytics']).config(function ($mdThemingProvider) {
  var customBlueMap = $mdThemingProvider.extendPalette('light-blue', {
    'contrastDefaultColor': 'light',
    'contrastDarkColors': ['50'],
    '50': 'ffffff'
  });
  $mdThemingProvider.definePalette('customBlue', customBlueMap);
  $mdThemingProvider.theme('default').primaryPalette('customBlue', {
    'default': '500',
    'hue-1': '50'
  }).accentPalette('pink');
  $mdThemingProvider.theme('input', 'default').primaryPalette('grey');
}).directive('iconText', function ($mdMedia) {
  return {
    restrict: 'E',
    scope: {
      tip: '@',
      icon: '@',
      style: '@?'
    },
    template: '<md-tooltip style="{{style}}" hide-gt-xs="hide-gt-xs">\n      {{tip}}\n    </md-tooltip>\n    <md-icon hide-gt-xs="hide-gt-xs" class="material-icons" style="{{style}}">\n      {{icon}}\n    </md-icon>\n    <span style="{{style}}" hide-xs>{{tip}}</span>'
  };
}).directive('loseFocus', function () {
  return {
    link: function link(scope, element, attrs) {
      scope.$watch(attrs.loseFocus, function (value) {
        if (value === true) {
          element[0].blur();
        }
      });
    }
  };
}).controller('homeContainer', ["$scope", "$http", "$mdToast", "$mdMedia", function (_, $http, $mdToast, $mdMedia) {
  _.api = 'http://ayudh.org:3337';
  _.losefocus = false;
  // _.api = 'http://localhost:3337'
  _.createdOne = localStorage.createdOne && parseInt(localStorage.createdOne) || 0;
  _.fetching = false;
  _.getSetsforTerm = function (term) {
    return $http.get(_.api + '/quizlet/search?query=' + term, { cache: true });
  };
  _.getSets = function (sets) {
    return $http.get(_.api + '/quizlet/sets?query=' + sets, { cache: true });
  };
  _.decks = JSON.parse(localStorage.decks || '{}');
  _.selected = JSON.parse(localStorage.selected || '{}');
  _.selectedOrder = "time";
  _.reverse = true;
  _.md = false;
  _.searched = "your last search term";
  _.numSelected = function () {
    return lo.size(_.selected);
  };
  _.numDecks = function () {
    return lo.size(_.decks);
  };
  _.selectedArray = function () {
    return lo.values(_.selected);
  };
  _.startIndexes = {};
  if (_.numSelected() > 0) {
    $mdToast.showSimple('You have ' + _.numSelected() + ' cards selected. Remember to clear them if you are making a new set.');
  }
  function selectTerm(term, setId) {
    if (term.selected) {
      _.selected[term.id] = lo.assign({}, term);
      _.selected[term.id].setId = setId;
      _.selected[term.id].time = new Date().getTime();
    } else {
      delete _.selected[term.id];
    }
    localStorage.selected = JSON.stringify(_.selected);
  }
  _.selectClickTerm = function (term, setId) {
    // checkbox check for tablet and below
    if (!$mdMedia('gt-md')) {
      term.selected = !term.selected;
      selectTerm(term, setId);
    }
  };
  _.selectDragTerm = function (term, setId) {
    var mouseDown = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;

    // drag anywhere for above that
    if ($mdMedia('gt-md')) {
      term.selected = mouseDown ? !term.selected : term.selected;
      selectTerm(term, setId);
    }
  };
  _.removeDeck = function (id) {
    return delete _.decks[id];
  };
  _.selectAll = function (id) {
    if (_.decks[id]) {
      // some unselected, then select all
      if (_.decks[id].terms.find(function (x) {
        return !x.selected;
      })) {
        _.decks[id].terms.forEach(function (term) {
          term.selected = true;
          _.selected[term.id] = lo.assign({}, term);
          _.selected[term.id].setId = id;
          _.selected[term.id].time = new Date().getTime();
        });
      } else {
        // unselect everything
        _.decks[id].terms.forEach(function (term) {
          term.selected = false;
          delete _.selected[term.id];
        });
      }
      localStorage.selected = JSON.stringify(_.selected);
    }
  };
  _.clearSelected = function () {
    _.selected = {};
    localStorage.selected = '{}';
  };
  _.swapSelected = function (id) {
    var _$selected$id = _.selected[id],
        term = _$selected$id.term,
        definition = _$selected$id.definition;

    _.selected[id].definition = term;
    _.selected[id].term = definition;
    localStorage.selected = JSON.stringify(_.selected);
  };
  _.removeSelected = function (id) {
    var _$selected$id2 = _.selected[id],
        setId = _$selected$id2.setId,
        rank = _$selected$id2.rank;

    if (_.decks[setId]) {
      _.decks[setId].terms[rank].selected = false;
    }
    delete _.selected[id];
    localStorage.selected = JSON.stringify(_.selected);
  };
  _.create = function (title) {
    _.url = null;
    _.creating = true;
    $http({
      method: 'POST',
      url: _.api + '/create-set',
      data: JSON.stringify({
        title: title,
        lang_terms: 'en',
        lang_definitions: 'en',
        data: lo.map(_.selected, function (v, k) {
          return lo.pick(v, ['term', 'definition', 'image']);
        })
      })
    }).then(function (res) {
      _.url = 'https://quizlet.com' + res.data.url;
      _.creating = false;
      if (res.data.error) {
        $mdToast.showSimple(res.data.error);
      } else {
        $mdToast.showSimple("Your deck is created");
        _.createdOne += 1;
        localStorage.createdOne = _.createdOne;
        _.selected_actions = 'home';
      }
    }).catch(function () {
      _.creating = false;
      _.selected_actions = 'home';
      $mdToast.showSimple("Unable to create deck");
    });
  };
  _.import = function (importUrl) {
    _.fetching = true;
    var x = importUrl && importUrl.match(/\d+/);
    x && x[0] && _.getSets(x[0]).then(function (res) {
      _.fetching = false;
      _.selected_actions = 'home';
      res.data.forEach(function (set) {
        set.terms.forEach(function (term) {
          term.selected = true;
          _.selected[term.id] = lo.assign({}, term);
          _.selected[term.id].setId = set.id;
          _.selected[term.id].time = new Date().getTime();
        });
      });
    }).catch(function () {
      _.fetching = false;
      _.selected_actions = 'home';
    });
    localStorage.selected = JSON.stringify(_.selected);
  };
  function getSets(setIds) {
    _.getSets(setIds.map(function (a) {
      return a.id;
    }).join(',')).then(function (res) {
      res.data.forEach(function (set) {
        var terms = lo.filter(set.terms, function (card) {
          if (_.bloom.test(card.term + card.definition)) {
            return false;
          } else {
            _.bloom.add(card.term + card.definition);
            return true;
          }
        });
        terms.forEach(function (t, i) {
          return t.rank = i;
        });
        if (terms.length > 2) {
          _.decks[set.id] = lo.pick(set, ['url', 'title', 'modified_date', 'lang_terms', 'lang_definitions']);
          _.decks[set.id].terms = terms;
          _.decks[set.id].terms_length = terms.length;
        }
      });
      _.fetching = false;
      _.selectedIndex = 0;
      localStorage.decks = JSON.stringify(_.decks);
      $mdToast.showSimple(_.numDecks() + " Quizlet decks loaded. Click the checkbox to choose a card.");
    }).catch(function () {
      _.fetching = false;
      $mdToast.showSimple("Unable to get terms - try another query");
    });
  }
  _.getTerms = function () {
    var replace = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
    var replaceBloom = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

    _.losefocus = true;
    var startIndex = 0;
    _.fetching = true;
    _.decks = !!replace ? {} : _.decks || {};
    _.bloom = !!replaceBloom ? new BloomFilter(3e5, 3e-5) : _.bloom || new BloomFilter(3e5, 3e-5);
    var term = _.search.trim();
    if (term.length > 2) {
      _.searched = term;
      _.getSetsforTerm(term.trim()).then(function (res) {
        _.startIndexes[term] = _.startIndexes[term] || 0;
        startIndex = _.startIndexes[term];
        getSets(res.data.sets.slice(startIndex, startIndex + 10));
        _.startIndexes[term] = _.startIndexes[term] + 10;
      }).catch(function () {
        _.fetching = false;
        $mdToast.showSimple("Unable to get terms - try another query");
      });
    }
  };
}]);

//# sourceMappingURL=data:application/json;base64,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LEdBQWEsSUFBYjtBQUNBLE1BQUUsS0FBRixHQUFVLENBQUMsQ0FBQyxPQUFGLEdBQVksRUFBWixHQUFrQixFQUFFLEtBQUYsSUFBVyxFQUF2QztBQUNBLE1BQUUsS0FBRixHQUFVLENBQUMsQ0FBQyxZQUFGLEdBQWlCLElBQUksV0FBSixDQUFnQixHQUFoQixFQUFxQixJQUFyQixDQUFqQixHQUErQyxFQUFFLEtBQUYsSUFBVyxJQUFJLFdBQUosQ0FBZ0IsR0FBaEIsRUFBcUIsSUFBckIsQ0FBcEU7QUFDQSxRQUFJLE9BQU8sRUFBRSxNQUFGLENBQVMsSUFBVCxFQUFYO0FBQ0EsUUFBRyxLQUFLLE1BQUwsR0FBYyxDQUFqQixFQUFtQjtBQUNqQixRQUFFLFFBQUYsR0FBYSxJQUFiO0FBQ0EsUUFBRSxjQUFGLENBQWlCLEtBQUssSUFBTCxFQUFqQixFQUE4QixJQUE5QixDQUFtQyxlQUFNO0FBQ3ZDLFVBQUUsWUFBRixDQUFlLElBQWYsSUFBdUIsRUFBRSxZQUFGLENBQWUsSUFBZixLQUF3QixDQUEvQztBQUNBLHFCQUFhLEVBQUUsWUFBRixDQUFlLElBQWYsQ0FBYjtBQUNBLGdCQUFRLElBQUksSUFBSixDQUFTLElBQVQsQ0FBYyxLQUFkLENBQW9CLFVBQXBCLEVBQStCLGFBQVcsRUFBMUMsQ0FBUjtBQUNBLFVBQUUsWUFBRixDQUFlLElBQWYsSUFBdUIsRUFBRSxZQUFGLENBQWUsSUFBZixJQUF1QixFQUE5QztBQUNELE9BTEQsRUFNQyxLQU5ELENBTU8sWUFBSTtBQUNULFVBQUUsUUFBRixHQUFhLEtBQWI7QUFDQSxpQkFBUyxVQUFULENBQW9CLHlDQUFwQjtBQUNELE9BVEQ7QUFVRDtBQUNGLEdBcEJEO0FBcUJELENBdEw0QixDQTdDbkIsQ0FBViIsImZpbGUiOiJhcHAucHJvZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIGJhYmVsXCI7XG5pZiAobG9jYXRpb24ucHJvdG9jb2wgIT0gJ2h0dHA6Jykge1xuICBsb2NhdGlvbi5wcm90b2NvbCA9ICdodHRwOic7XG59XG4vLyBpZiAoJ3NlcnZpY2VXb3JrZXInIGluIG5hdmlnYXRvcikge1xuLy8gICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3Rlcignc2VydmljZS13b3JrZXIuanMnKTtcbi8vIH1cbi8vIHJlbW92ZWQgc2VydmljZSB3b3JrZXJzIGFuZCBmZXRjaCBiZWNhdXNlIHF1aXpsZXQgZG9lcyBub3QgZG8gY29ycyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8zNDk0MDA3NCBcbi8vIG5vLWNvcnMgbW9kZSB3b24ndCBzZW5kIGF1dGhvcml6YXRpb24gaGVhZGVyIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9SZXF1ZXN0L21vZGVcbnZhciBsbyA9IF87XG4vLyB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2RlY2tqYW0nLCBbJ25nTWF0ZXJpYWwnXSlcbnZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZGVja2phbScsIFsnbmdNYXRlcmlhbCcsICdhbmd1bGFydGljcycsICdhbmd1bGFydGljcy5nb29nbGUuYW5hbHl0aWNzJ10pXG4uY29uZmlnKGZ1bmN0aW9uKCRtZFRoZW1pbmdQcm92aWRlcikge1xuICB2YXIgY3VzdG9tQmx1ZU1hcCA9ICRtZFRoZW1pbmdQcm92aWRlci5leHRlbmRQYWxldHRlKCdsaWdodC1ibHVlJywge1xuICAgICdjb250cmFzdERlZmF1bHRDb2xvcic6ICdsaWdodCcsXG4gICAgJ2NvbnRyYXN0RGFya0NvbG9ycyc6IFsnNTAnXSxcbiAgICAnNTAnOiAnZmZmZmZmJ1xuICB9KVxuICAkbWRUaGVtaW5nUHJvdmlkZXIuZGVmaW5lUGFsZXR0ZSgnY3VzdG9tQmx1ZScsIGN1c3RvbUJsdWVNYXApXG4gICRtZFRoZW1pbmdQcm92aWRlci50aGVtZSgnZGVmYXVsdCcpXG4gICAgLnByaW1hcnlQYWxldHRlKCdjdXN0b21CbHVlJywge1xuICAgICAgJ2RlZmF1bHQnOiAnNTAwJyxcbiAgICAgICdodWUtMSc6ICc1MCdcbiAgICB9KVxuICAgIC5hY2NlbnRQYWxldHRlKCdwaW5rJylcbiAgJG1kVGhlbWluZ1Byb3ZpZGVyLnRoZW1lKCdpbnB1dCcsICdkZWZhdWx0JylcbiAgICAucHJpbWFyeVBhbGV0dGUoJ2dyZXknKVxufSlcbi5kaXJlY3RpdmUoJ2ljb25UZXh0JywgZnVuY3Rpb24oJG1kTWVkaWEpIHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0UnLFxuICAgIHNjb3BlOiB7XG4gICAgICB0aXA6ICdAJyxcbiAgICAgIGljb246ICdAJyxcbiAgICAgIHN0eWxlOiAnQD8nXG4gICAgfSxcbiAgICB0ZW1wbGF0ZTogYDxtZC10b29sdGlwIHN0eWxlPVwie3tzdHlsZX19XCIgaGlkZS1ndC14cz1cImhpZGUtZ3QteHNcIj5cbiAgICAgIHt7dGlwfX1cbiAgICA8L21kLXRvb2x0aXA+XG4gICAgPG1kLWljb24gaGlkZS1ndC14cz1cImhpZGUtZ3QteHNcIiBjbGFzcz1cIm1hdGVyaWFsLWljb25zXCIgc3R5bGU9XCJ7e3N0eWxlfX1cIj5cbiAgICAgIHt7aWNvbn19XG4gICAgPC9tZC1pY29uPlxuICAgIDxzcGFuIHN0eWxlPVwie3tzdHlsZX19XCIgaGlkZS14cz57e3RpcH19PC9zcGFuPmBcbiAgfVxufSlcbi5kaXJlY3RpdmUoJ2xvc2VGb2N1cycsIGZ1bmN0aW9uKCkge1xuICByZXR1cm4ge1xuICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykge1xuICAgICAgc2NvcGUuJHdhdGNoKGF0dHJzLmxvc2VGb2N1cywgZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgaWYodmFsdWUgPT09IHRydWUpIHtcbiAgICAgICAgICBlbGVtZW50WzBdLmJsdXIoKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxufSlcbi5jb250cm9sbGVyKCdob21lQ29udGFpbmVyJywgW1wiJHNjb3BlXCIsIFwiJGh0dHBcIiwgXCIkbWRUb2FzdFwiLCBcIiRtZE1lZGlhXCIgLChfLCAkaHR0cCwgJG1kVG9hc3QsICRtZE1lZGlhKT0+IHtcbiAgXy5hcGkgPSAnaHR0cDovL2F5dWRoLm9yZzozMzM3J1xuICBfLmxvc2Vmb2N1cyA9IGZhbHNlXG4gIC8vIF8uYXBpID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzMzNydcbiAgXy5jcmVhdGVkT25lID0gbG9jYWxTdG9yYWdlLmNyZWF0ZWRPbmUgJiYgcGFyc2VJbnQobG9jYWxTdG9yYWdlLmNyZWF0ZWRPbmUpIHx8IDBcbiAgXy5mZXRjaGluZyA9IGZhbHNlXG4gIF8uZ2V0U2V0c2ZvclRlcm0gPSAodGVybSk9PiAkaHR0cC5nZXQoYCR7Xy5hcGl9L3F1aXpsZXQvc2VhcmNoP3F1ZXJ5PSR7dGVybX1gLCB7IGNhY2hlOiB0cnVlfSlcbiAgXy5nZXRTZXRzID0gKHNldHMpPT4gJGh0dHAuZ2V0KGAke18uYXBpfS9xdWl6bGV0L3NldHM/cXVlcnk9JHtzZXRzfWAsIHsgY2FjaGU6IHRydWV9KVxuICBfLmRlY2tzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZGVja3MgfHwgJ3t9JylcbiAgXy5zZWxlY3RlZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLnNlbGVjdGVkIHx8ICd7fScpXG4gIF8uc2VsZWN0ZWRPcmRlciA9IFwidGltZVwiXG4gIF8ucmV2ZXJzZSA9IHRydWVcbiAgXy5tZCA9IGZhbHNlXG4gIF8uc2VhcmNoZWQgPSBcInlvdXIgbGFzdCBzZWFyY2ggdGVybVwiXG4gIF8ubnVtU2VsZWN0ZWQgPSAoKT0+IGxvLnNpemUoXy5zZWxlY3RlZClcbiAgXy5udW1EZWNrcyA9ICgpPT4gbG8uc2l6ZShfLmRlY2tzKVxuICBfLnNlbGVjdGVkQXJyYXkgPSAoKT0+IGxvLnZhbHVlcyhfLnNlbGVjdGVkKVxuICBfLnN0YXJ0SW5kZXhlcyA9IHt9XG4gIGlmKF8ubnVtU2VsZWN0ZWQoKSA+IDApe1xuICAgICRtZFRvYXN0LnNob3dTaW1wbGUoYFlvdSBoYXZlICR7Xy5udW1TZWxlY3RlZCgpfSBjYXJkcyBzZWxlY3RlZC4gUmVtZW1iZXIgdG8gY2xlYXIgdGhlbSBpZiB5b3UgYXJlIG1ha2luZyBhIG5ldyBzZXQuYClcbiAgfVxuICBmdW5jdGlvbiBzZWxlY3RUZXJtKHRlcm0sIHNldElkKSB7XG4gICAgaWYgKHRlcm0uc2VsZWN0ZWQpIHtcbiAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0gPSBsby5hc3NpZ24oe30sdGVybSlcbiAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0uc2V0SWQgPSBzZXRJZFxuICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXS50aW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKVxuICAgIH0gZWxzZSB7XG4gICAgICBkZWxldGUgXy5zZWxlY3RlZFt0ZXJtLmlkXVxuICAgIH1cbiAgICBsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgPSBKU09OLnN0cmluZ2lmeShfLnNlbGVjdGVkKVxuICB9XG4gIF8uc2VsZWN0Q2xpY2tUZXJtID0gKHRlcm0sIHNldElkKSA9PiB7XG4gICAgLy8gY2hlY2tib3ggY2hlY2sgZm9yIHRhYmxldCBhbmQgYmVsb3dcbiAgICBpZighJG1kTWVkaWEoJ2d0LW1kJykpIHtcbiAgICAgIHRlcm0uc2VsZWN0ZWQgPSAhdGVybS5zZWxlY3RlZFxuICAgICAgc2VsZWN0VGVybSh0ZXJtLCBzZXRJZClcbiAgICB9XG4gIH1cbiAgXy5zZWxlY3REcmFnVGVybSA9ICh0ZXJtLCBzZXRJZCwgbW91c2VEb3duPXRydWUpID0+IHtcbiAgICAvLyBkcmFnIGFueXdoZXJlIGZvciBhYm92ZSB0aGF0XG4gICAgaWYoJG1kTWVkaWEoJ2d0LW1kJykpe1xuICAgICAgdGVybS5zZWxlY3RlZCA9IChtb3VzZURvd24pID8gIXRlcm0uc2VsZWN0ZWQgOiB0ZXJtLnNlbGVjdGVkXG4gICAgICBzZWxlY3RUZXJtKHRlcm0sIHNldElkKVxuICAgIH1cbiAgfVxuICBfLnJlbW92ZURlY2sgPSBpZD0+IGRlbGV0ZSBfLmRlY2tzW2lkXVxuICBfLnNlbGVjdEFsbCA9IGlkPT4ge1xuICAgIGlmIChfLmRlY2tzW2lkXSkge1xuICAgICAgLy8gc29tZSB1bnNlbGVjdGVkLCB0aGVuIHNlbGVjdCBhbGxcbiAgICAgIGlmIChfLmRlY2tzW2lkXS50ZXJtcy5maW5kKHg9PiAheC5zZWxlY3RlZCkpe1xuICAgICAgICBfLmRlY2tzW2lkXS50ZXJtcy5mb3JFYWNoKHRlcm0gPT4ge1xuICAgICAgICAgIHRlcm0uc2VsZWN0ZWQgPSB0cnVlXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXSA9IGxvLmFzc2lnbih7fSx0ZXJtKVxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0uc2V0SWQgPSBpZFxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0udGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKClcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHVuc2VsZWN0IGV2ZXJ5dGhpbmdcbiAgICAgICAgXy5kZWNrc1tpZF0udGVybXMuZm9yRWFjaCh0ZXJtID0+IHtcbiAgICAgICAgICB0ZXJtLnNlbGVjdGVkID0gZmFsc2VcbiAgICAgICAgICBkZWxldGUgXy5zZWxlY3RlZFt0ZXJtLmlkXVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgbG9jYWxTdG9yYWdlLnNlbGVjdGVkID0gSlNPTi5zdHJpbmdpZnkoXy5zZWxlY3RlZClcbiAgICB9XG4gIH1cbiAgXy5jbGVhclNlbGVjdGVkID0gKCk9PiB7XG4gICAgXy5zZWxlY3RlZCA9IHt9XG4gICAgbG9jYWxTdG9yYWdlLnNlbGVjdGVkID0gJ3t9J1xuICB9XG4gIF8uc3dhcFNlbGVjdGVkID0gaWQ9PiB7XG4gICAgdmFyIHt0ZXJtLCBkZWZpbml0aW9ufSA9IF8uc2VsZWN0ZWRbaWRdXG4gICAgXy5zZWxlY3RlZFtpZF0uZGVmaW5pdGlvbiA9IHRlcm1cbiAgICBfLnNlbGVjdGVkW2lkXS50ZXJtID0gZGVmaW5pdGlvblxuICAgIGxvY2FsU3RvcmFnZS5zZWxlY3RlZCA9IEpTT04uc3RyaW5naWZ5KF8uc2VsZWN0ZWQpXG4gIH1cbiAgXy5yZW1vdmVTZWxlY3RlZCA9IGlkPT4ge1xuICAgIHZhciB7c2V0SWQsIHJhbmt9ID0gXy5zZWxlY3RlZFtpZF1cbiAgICBpZihfLmRlY2tzW3NldElkXSkge1xuICAgICAgXy5kZWNrc1tzZXRJZF0udGVybXNbcmFua10uc2VsZWN0ZWQgPSBmYWxzZVxuICAgIH1cbiAgICBkZWxldGUgXy5zZWxlY3RlZFtpZF1cbiAgICBsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgPSBKU09OLnN0cmluZ2lmeShfLnNlbGVjdGVkKVxuICB9XG4gIF8uY3JlYXRlID0gKHRpdGxlKT0+IHtcbiAgICBfLnVybCA9IG51bGxcbiAgICBfLmNyZWF0aW5nID0gdHJ1ZVxuICAgICRodHRwKHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiBgJHtfLmFwaX0vY3JlYXRlLXNldGAsXG4gICAgICBkYXRhOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHRpdGxlOiB0aXRsZSxcbiAgICAgICAgbGFuZ190ZXJtczogJ2VuJyxcbiAgICAgICAgbGFuZ19kZWZpbml0aW9uczogJ2VuJyxcbiAgICAgICAgZGF0YTogbG8ubWFwKF8uc2VsZWN0ZWQsICh2LGspPT4gbG8ucGljayh2LCBbJ3Rlcm0nLCAnZGVmaW5pdGlvbicsICdpbWFnZSddKSlcbiAgICAgIH0pXG4gICAgfSkudGhlbihyZXM9PntcbiAgICAgIF8udXJsID0gYGh0dHBzOi8vcXVpemxldC5jb20ke3Jlcy5kYXRhLnVybH1gXG4gICAgICBfLmNyZWF0aW5nID0gZmFsc2VcbiAgICAgIGlmIChyZXMuZGF0YS5lcnJvcikge1xuICAgICAgICAkbWRUb2FzdC5zaG93U2ltcGxlKHJlcy5kYXRhLmVycm9yKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgJG1kVG9hc3Quc2hvd1NpbXBsZShcIllvdXIgZGVjayBpcyBjcmVhdGVkXCIpXG4gICAgICAgIF8uY3JlYXRlZE9uZSArPSAxXG4gICAgICAgIGxvY2FsU3RvcmFnZS5jcmVhdGVkT25lID0gXy5jcmVhdGVkT25lXG4gICAgICAgIF8uc2VsZWN0ZWRfYWN0aW9ucyA9ICdob21lJ1xuICAgICAgfVxuICAgIH0pLmNhdGNoKCgpPT57XG4gICAgICBfLmNyZWF0aW5nPWZhbHNlXG4gICAgICBfLnNlbGVjdGVkX2FjdGlvbnMgPSAnaG9tZSdcbiAgICAgICRtZFRvYXN0LnNob3dTaW1wbGUoXCJVbmFibGUgdG8gY3JlYXRlIGRlY2tcIilcbiAgICB9KVxuICB9XG4gIF8uaW1wb3J0ID0gKGltcG9ydFVybCkgPT4ge1xuICAgIF8uZmV0Y2hpbmcgPSB0cnVlXG4gICAgdmFyIHggPSBpbXBvcnRVcmwgJiYgaW1wb3J0VXJsLm1hdGNoKC9cXGQrLylcbiAgICB4ICYmIHhbMF0gJiYgXy5nZXRTZXRzKHhbMF0pLnRoZW4ocmVzPT57XG4gICAgICBfLmZldGNoaW5nID0gZmFsc2VcbiAgICAgIF8uc2VsZWN0ZWRfYWN0aW9ucyA9ICdob21lJ1xuICAgICAgcmVzLmRhdGEuZm9yRWFjaChzZXQ9PiB7XG4gICAgICAgIHNldC50ZXJtcy5mb3JFYWNoKHRlcm0gPT4ge1xuICAgICAgICAgIHRlcm0uc2VsZWN0ZWQgPSB0cnVlXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXSA9IGxvLmFzc2lnbih7fSx0ZXJtKVxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0uc2V0SWQgPSBzZXQuaWRcbiAgICAgICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdLnRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0pLmNhdGNoKCgpPT57XG4gICAgICBfLmZldGNoaW5nID0gZmFsc2VcbiAgICAgIF8uc2VsZWN0ZWRfYWN0aW9ucyA9ICdob21lJ1xuICAgIH0pXG4gICAgbG9jYWxTdG9yYWdlLnNlbGVjdGVkID0gSlNPTi5zdHJpbmdpZnkoXy5zZWxlY3RlZClcbiAgfVxuICBmdW5jdGlvbiBnZXRTZXRzKHNldElkcykge1xuICAgIF8uZ2V0U2V0cyhzZXRJZHMubWFwKGE9PmEuaWQpLmpvaW4oJywnKSlcbiAgICAudGhlbihyZXMgPT4ge1xuICAgICAgcmVzLmRhdGEuZm9yRWFjaChzZXQ9PiB7XG4gICAgICAgIHZhciB0ZXJtcyA9IGxvLmZpbHRlcihzZXQudGVybXMsIGNhcmQ9PiB7XG4gICAgICAgICAgaWYgKF8uYmxvb20udGVzdChjYXJkLnRlcm0gKyBjYXJkLmRlZmluaXRpb24pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgXy5ibG9vbS5hZGQoY2FyZC50ZXJtICsgY2FyZC5kZWZpbml0aW9uKVxuICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIHRlcm1zLmZvckVhY2goKHQsaSkgPT4gdC5yYW5rID0gaSlcbiAgICAgICAgaWYgKHRlcm1zLmxlbmd0aCA+IDIpe1xuICAgICAgICAgIF8uZGVja3Nbc2V0LmlkXSA9IGxvLnBpY2soc2V0LCBbJ3VybCcsICd0aXRsZScsICdtb2RpZmllZF9kYXRlJywgJ2xhbmdfdGVybXMnLCAnbGFuZ19kZWZpbml0aW9ucyddKVxuICAgICAgICAgIF8uZGVja3Nbc2V0LmlkXS50ZXJtcyA9IHRlcm1zXG4gICAgICAgICAgXy5kZWNrc1tzZXQuaWRdLnRlcm1zX2xlbmd0aCA9IHRlcm1zLmxlbmd0aFxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgXy5mZXRjaGluZyA9IGZhbHNlXG4gICAgICBfLnNlbGVjdGVkSW5kZXg9MFxuICAgICAgbG9jYWxTdG9yYWdlLmRlY2tzID0gSlNPTi5zdHJpbmdpZnkoXy5kZWNrcylcbiAgICAgICRtZFRvYXN0LnNob3dTaW1wbGUoXy5udW1EZWNrcygpICsgXCIgUXVpemxldCBkZWNrcyBsb2FkZWQuIENsaWNrIHRoZSBjaGVja2JveCB0byBjaG9vc2UgYSBjYXJkLlwiKVxuICAgIH0pLmNhdGNoKCgpPT57XG4gICAgICBfLmZldGNoaW5nID0gZmFsc2VcbiAgICAgICRtZFRvYXN0LnNob3dTaW1wbGUoXCJVbmFibGUgdG8gZ2V0IHRlcm1zIC0gdHJ5IGFub3RoZXIgcXVlcnlcIilcbiAgICB9KVxuICB9XG4gIF8uZ2V0VGVybXMgPSAocmVwbGFjZT10cnVlLCByZXBsYWNlQmxvb209dHJ1ZSk9PiB7XG4gICAgXy5sb3NlZm9jdXMgPSB0cnVlXG4gICAgdmFyIHN0YXJ0SW5kZXggPSAwO1xuICAgIF8uZmV0Y2hpbmcgPSB0cnVlXG4gICAgXy5kZWNrcyA9ICEhcmVwbGFjZSA/IHt9IDogKF8uZGVja3MgfHwge30pXG4gICAgXy5ibG9vbSA9ICEhcmVwbGFjZUJsb29tID8gbmV3IEJsb29tRmlsdGVyKDNlNSwgM2UtNSkgOiAoXy5ibG9vbSB8fCBuZXcgQmxvb21GaWx0ZXIoM2U1LCAzZS01KSlcbiAgICB2YXIgdGVybSA9IF8uc2VhcmNoLnRyaW0oKVxuICAgIGlmKHRlcm0ubGVuZ3RoID4gMil7XG4gICAgICBfLnNlYXJjaGVkID0gdGVybVxuICAgICAgXy5nZXRTZXRzZm9yVGVybSh0ZXJtLnRyaW0oKSkudGhlbihyZXM9PiB7XG4gICAgICAgIF8uc3RhcnRJbmRleGVzW3Rlcm1dID0gXy5zdGFydEluZGV4ZXNbdGVybV0gfHwgMFxuICAgICAgICBzdGFydEluZGV4ID0gXy5zdGFydEluZGV4ZXNbdGVybV1cbiAgICAgICAgZ2V0U2V0cyhyZXMuZGF0YS5zZXRzLnNsaWNlKHN0YXJ0SW5kZXgsc3RhcnRJbmRleCsxMCkpXG4gICAgICAgIF8uc3RhcnRJbmRleGVzW3Rlcm1dID0gXy5zdGFydEluZGV4ZXNbdGVybV0gKyAxMFxuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoKT0+e1xuICAgICAgICBfLmZldGNoaW5nID0gZmFsc2VcbiAgICAgICAgJG1kVG9hc3Quc2hvd1NpbXBsZShcIlVuYWJsZSB0byBnZXQgdGVybXMgLSB0cnkgYW5vdGhlciBxdWVyeVwiKVxuICAgICAgfSlcbiAgICB9XG4gIH1cbn1dKVxuIl19
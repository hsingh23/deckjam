"use strict";
"use babel";

if ((!location.port || location.port == "80") && location.protocol != 'https:') {
  location.protocol = 'https:';
}
// if ('serviceWorker' in navigator) {
//   navigator.serviceWorker.register('service-worker.js');
// }
// removed service workers and fetch because quizlet does not do cors http://stackoverflow.com/a/34940074 
// no-cors mode won't send authorization header https://developer.mozilla.org/en-US/docs/Web/API/Request/mode
var lo = _;
var app = angular.module('deckjam', ['ngMaterial']).config(function ($mdThemingProvider) {
  var customBlueMap = $mdThemingProvider.extendPalette('light-blue', {
    'contrastDefaultColor': 'light',
    'contrastDarkColors': ['50'],
    '50': 'ffffff'
  });
  $mdThemingProvider.definePalette('customBlue', customBlueMap);
  $mdThemingProvider.theme('default').primaryPalette('customBlue', {
    'default': '500',
    'hue-1': '50'
  }).accentPalette('pink');
  $mdThemingProvider.theme('input', 'default').primaryPalette('grey');
}).controller('homeContainer', ["$scope", "$http", function (_, $http) {
  _.getSetsforTerm = function (term) {
    return $http.get("http://ayudh.org:3337/quizlet/search?query=" + term, { cache: true });
  };
  _.getSets = function (sets) {
    return $http.get("http://ayudh.org:3337/quizlet/sets?query=" + sets, { cache: true });
  };
  _.decks = JSON.parse(localStorage.decks || '{}');
  _.selected = JSON.parse(localStorage.selected || '{}');
  _.selectedOrder = "time";
  _.reverse = true;
  _.md = false;
  _.selectedArray = function () {
    return lo.values(_.selected);
  };
  _.selectTerm = function (term, setId) {
    var mouseDown = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;

    term.selected = !!mouseDown ? !!!term.selected : !!term.selected;
    if (term.selected) {
      _.selected[term.id] = lo.assign({}, term);
      _.selected[term.id].setId = setId;
      _.selected[term.id].time = new Date().getTime();
    } else {
      delete _.selected[term.id];
    }
    localStorage.selected = JSON.stringify(_.selected);
  };
  _.removeDeck = function (id) {
    return delete _.decks[id];
  };
  _.selectAll = function (id) {
    if (_.decks[id]) {
      // all selected, then unselect all
      if (_.decks[id].terms.find(function (x) {
        return !!x.selected;
      })) {
        _.decks[id].terms.forEach(function (term) {
          term.selected = false;
          delete _.selected[term.id];
        });
      } else {
        _.decks[id].terms.forEach(function (term) {
          term.selected = true;
          _.selected[term.id] = lo.assign({}, term);
          _.selected[term.id].setId = id;
          _.selected[term.id].time = new Date().getTime();
        });
      }
      localStorage.selected = JSON.stringify(_.selected);
    }
  };
  _.clearSelected = function () {
    _.selected = {};
    localStorage.selected = '{}';
  };
  _.swapSelected = function (id) {
    var _$selected$id = _.selected[id],
        term = _$selected$id.term,
        definition = _$selected$id.definition;

    _.selected[id].definition = term;
    _.selected[id].term = definition;
  };
  _.removeSelected = function (id) {
    var _$selected$id2 = _.selected[id],
        setId = _$selected$id2.setId,
        rank = _$selected$id2.rank;

    if (_.decks[setId]) {
      _.decks[setId].terms[rank].selected = false;
    }
    delete _.selected[id];
  };
  _.create = function (title) {
    _.url = null;
    _.creating = true;
    $http({
      method: 'POST',
      url: 'http://ayudh.org:3337/create-set',
      data: JSON.stringify({
        title: title,
        lang_terms: 'en',
        lang_definitions: 'en',
        data: lo.map(_.selected, function (v, k) {
          return lo.pick(v, ['term', 'definition', 'image']);
        })
      })
    }).then(function (res) {
      _.url = "https://quizlet.com" + res.data.url;
      _.creating = false;
    }).catch(function () {
      _.creating = false;
    });
  };
  _.import = function (importUrl) {
    var x = importUrl && importUrl.match(/\d+/);
    x && x[0] && _.getSets(x[0]).then(function (res) {
      res.data.forEach(function (set) {
        set.terms.forEach(function (term) {
          term.selected = true;
          _.selected[term.id] = lo.assign({}, term);
          _.selected[term.id].setId = set.id;
          _.selected[term.id].time = new Date().getTime();
        });
      });
    });
  };
  _.getTerms = function (replace) {
    _.decks = !!replace ? {} : _.decks || {};
    _.bloom = !!replace ? new BloomFilter(3e5, 3e-5) : _.bloom || new BloomFilter(3e5, 3e-5);
    _.search.split(',').forEach(function (term) {
      _.getSetsforTerm(term.trim()).then(function (data) {
        _.getSets(data.data.sets.map(function (a) {
          return a.id;
        }).join(',')).then(function (res) {
          res.data.forEach(function (set) {
            var terms = lo.filter(set.terms, function (card) {
              if (_.bloom.test(card.term + card.definition)) {
                return false;
              } else {
                _.bloom.add(card.term + card.definition);
                return true;
              }
            });
            terms.forEach(function (t, i) {
              return t.rank = i;
            });
            if (terms.length > 2) {
              _.decks[set.id] = lo.pick(set, ['url', 'title', 'modified_date', 'lang_terms', 'lang_definitions']);
              _.decks[set.id].terms = terms;
              _.decks[set.id].terms_length = terms.length;
            }
          });
          localStorage.decks = JSON.stringify(_.decks);
        });
      });
    });
  };
}]);

//# sourceMappingURL=data:application/json;base64,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Q0Q7QUFDRixXQWZEO0FBZ0JBLHVCQUFhLEtBQWIsR0FBcUIsS0FBSyxTQUFMLENBQWUsRUFBRSxLQUFqQixDQUFyQjtBQUNELFNBbkJIO0FBb0JDLE9BckJIO0FBc0JDLEtBdkJIO0FBd0JDLEdBM0JIO0FBNEJELENBbEg0QixDQWpCbkIsQ0FBViIsImZpbGUiOiJhcHAucHJvZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIGJhYmVsXCI7XG5pZiAoKCFsb2NhdGlvbi5wb3J0IHx8IGxvY2F0aW9uLnBvcnQgPT0gXCI4MFwiKSAmJiBsb2NhdGlvbi5wcm90b2NvbCAhPSAnaHR0cHM6Jykge1xuICBsb2NhdGlvbi5wcm90b2NvbCA9ICdodHRwczonO1xufVxuLy8gaWYgKCdzZXJ2aWNlV29ya2VyJyBpbiBuYXZpZ2F0b3IpIHtcbi8vICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJ3NlcnZpY2Utd29ya2VyLmpzJyk7XG4vLyB9XG4vLyByZW1vdmVkIHNlcnZpY2Ugd29ya2VycyBhbmQgZmV0Y2ggYmVjYXVzZSBxdWl6bGV0IGRvZXMgbm90IGRvIGNvcnMgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzQ5NDAwNzQgXG4vLyBuby1jb3JzIG1vZGUgd29uJ3Qgc2VuZCBhdXRob3JpemF0aW9uIGhlYWRlciBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvUmVxdWVzdC9tb2RlXG52YXIgbG8gPSBfO1xudmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdkZWNramFtJywgWyduZ01hdGVyaWFsJ10pXG4uY29uZmlnKGZ1bmN0aW9uKCRtZFRoZW1pbmdQcm92aWRlcikge1xuICB2YXIgY3VzdG9tQmx1ZU1hcCA9ICRtZFRoZW1pbmdQcm92aWRlci5leHRlbmRQYWxldHRlKCdsaWdodC1ibHVlJywge1xuICAgICdjb250cmFzdERlZmF1bHRDb2xvcic6ICdsaWdodCcsXG4gICAgJ2NvbnRyYXN0RGFya0NvbG9ycyc6IFsnNTAnXSxcbiAgICAnNTAnOiAnZmZmZmZmJ1xuICB9KVxuICAkbWRUaGVtaW5nUHJvdmlkZXIuZGVmaW5lUGFsZXR0ZSgnY3VzdG9tQmx1ZScsIGN1c3RvbUJsdWVNYXApXG4gICRtZFRoZW1pbmdQcm92aWRlci50aGVtZSgnZGVmYXVsdCcpXG4gICAgLnByaW1hcnlQYWxldHRlKCdjdXN0b21CbHVlJywge1xuICAgICAgJ2RlZmF1bHQnOiAnNTAwJyxcbiAgICAgICdodWUtMSc6ICc1MCdcbiAgICB9KVxuICAgIC5hY2NlbnRQYWxldHRlKCdwaW5rJylcbiAgJG1kVGhlbWluZ1Byb3ZpZGVyLnRoZW1lKCdpbnB1dCcsICdkZWZhdWx0JylcbiAgICAucHJpbWFyeVBhbGV0dGUoJ2dyZXknKVxufSlcbi5jb250cm9sbGVyKCdob21lQ29udGFpbmVyJywgW1wiJHNjb3BlXCIsXCIkaHR0cFwiLChfLCAkaHR0cCk9PiB7XG4gIF8uZ2V0U2V0c2ZvclRlcm0gPSAodGVybSk9PiAkaHR0cC5nZXQoYGh0dHA6Ly9heXVkaC5vcmc6MzMzNy9xdWl6bGV0L3NlYXJjaD9xdWVyeT0ke3Rlcm19YCwgeyBjYWNoZTogdHJ1ZX0pXG4gIF8uZ2V0U2V0cyA9IChzZXRzKT0+ICRodHRwLmdldChgaHR0cDovL2F5dWRoLm9yZzozMzM3L3F1aXpsZXQvc2V0cz9xdWVyeT0ke3NldHN9YCwgeyBjYWNoZTogdHJ1ZX0pXG4gIF8uZGVja3MgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5kZWNrcyB8fCAne30nKVxuICBfLnNlbGVjdGVkID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgfHwgJ3t9JylcbiAgXy5zZWxlY3RlZE9yZGVyID0gXCJ0aW1lXCJcbiAgXy5yZXZlcnNlID0gdHJ1ZVxuICBfLm1kID0gZmFsc2VcbiAgXy5zZWxlY3RlZEFycmF5ID0gKCk9PiBsby52YWx1ZXMoXy5zZWxlY3RlZClcbiAgXy5zZWxlY3RUZXJtID0gKHRlcm0sIHNldElkLCBtb3VzZURvd249dHJ1ZSkgPT4ge1xuICAgIHRlcm0uc2VsZWN0ZWQgPSAoISFtb3VzZURvd24pID8gISEhdGVybS5zZWxlY3RlZCA6ICEhdGVybS5zZWxlY3RlZFxuICAgIGlmICh0ZXJtLnNlbGVjdGVkKSB7XG4gICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdID0gbG8uYXNzaWduKHt9LHRlcm0pXG4gICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdLnNldElkID0gc2V0SWRcbiAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0udGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKClcbiAgICB9IGVsc2Uge1xuICAgICAgZGVsZXRlIF8uc2VsZWN0ZWRbdGVybS5pZF1cbiAgICB9XG4gICAgbG9jYWxTdG9yYWdlLnNlbGVjdGVkID0gSlNPTi5zdHJpbmdpZnkoXy5zZWxlY3RlZClcbiAgfVxuICBfLnJlbW92ZURlY2sgPSBpZD0+IGRlbGV0ZSBfLmRlY2tzW2lkXVxuICBfLnNlbGVjdEFsbCA9IGlkPT4ge1xuICAgIGlmIChfLmRlY2tzW2lkXSkge1xuICAgICAgLy8gYWxsIHNlbGVjdGVkLCB0aGVuIHVuc2VsZWN0IGFsbFxuICAgICAgaWYgKF8uZGVja3NbaWRdLnRlcm1zLmZpbmQoeD0+ICEheC5zZWxlY3RlZCkpe1xuICAgICAgICBfLmRlY2tzW2lkXS50ZXJtcy5mb3JFYWNoKHRlcm0gPT4ge1xuICAgICAgICAgIHRlcm0uc2VsZWN0ZWQgPSBmYWxzZVxuICAgICAgICAgIGRlbGV0ZSBfLnNlbGVjdGVkW3Rlcm0uaWRdXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBfLmRlY2tzW2lkXS50ZXJtcy5mb3JFYWNoKHRlcm0gPT4ge1xuICAgICAgICAgIHRlcm0uc2VsZWN0ZWQgPSB0cnVlXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXSA9IGxvLmFzc2lnbih7fSx0ZXJtKVxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0uc2V0SWQgPSBpZFxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0udGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGxvY2FsU3RvcmFnZS5zZWxlY3RlZCA9IEpTT04uc3RyaW5naWZ5KF8uc2VsZWN0ZWQpXG4gICAgfVxuICB9XG4gIF8uY2xlYXJTZWxlY3RlZCA9ICgpPT4ge1xuICAgIF8uc2VsZWN0ZWQgPSB7fVxuICAgIGxvY2FsU3RvcmFnZS5zZWxlY3RlZCA9ICd7fSdcbiAgfVxuICBfLnN3YXBTZWxlY3RlZCA9IGlkPT4ge1xuICAgIHZhciB7dGVybSwgZGVmaW5pdGlvbn0gPSBfLnNlbGVjdGVkW2lkXVxuICAgIF8uc2VsZWN0ZWRbaWRdLmRlZmluaXRpb24gPSB0ZXJtXG4gICAgXy5zZWxlY3RlZFtpZF0udGVybSA9IGRlZmluaXRpb25cbiAgfVxuICBfLnJlbW92ZVNlbGVjdGVkID0gaWQ9PiB7XG4gICAgdmFyIHtzZXRJZCwgcmFua30gPSBfLnNlbGVjdGVkW2lkXVxuICAgIGlmKF8uZGVja3Nbc2V0SWRdKSB7XG4gICAgICBfLmRlY2tzW3NldElkXS50ZXJtc1tyYW5rXS5zZWxlY3RlZCA9IGZhbHNlXG4gICAgfVxuICAgIGRlbGV0ZSBfLnNlbGVjdGVkW2lkXVxuICB9XG4gIF8uY3JlYXRlID0gKHRpdGxlKT0+IHtcbiAgICBfLnVybCA9IG51bGxcbiAgICBfLmNyZWF0aW5nID0gdHJ1ZVxuICAgICRodHRwKHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiAnaHR0cDovL2F5dWRoLm9yZzozMzM3L2NyZWF0ZS1zZXQnLFxuICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICB0aXRsZTogdGl0bGUsXG4gICAgICAgIGxhbmdfdGVybXM6ICdlbicsXG4gICAgICAgIGxhbmdfZGVmaW5pdGlvbnM6ICdlbicsXG4gICAgICAgIGRhdGE6IGxvLm1hcChfLnNlbGVjdGVkLCAodixrKT0+IGxvLnBpY2sodiwgWyd0ZXJtJywgJ2RlZmluaXRpb24nLCAnaW1hZ2UnXSkpXG4gICAgICB9KVxuICAgIH0pLnRoZW4ocmVzPT57XG4gICAgICBfLnVybCA9IGBodHRwczovL3F1aXpsZXQuY29tJHtyZXMuZGF0YS51cmx9YFxuICAgICAgXy5jcmVhdGluZyA9IGZhbHNlXG4gICAgfSkuY2F0Y2goKCk9PntfLmNyZWF0aW5nPWZhbHNlfSlcbiAgfVxuICBfLmltcG9ydCA9IChpbXBvcnRVcmwpID0+IHtcbiAgICB2YXIgeCA9IGltcG9ydFVybCAmJiBpbXBvcnRVcmwubWF0Y2goL1xcZCsvKVxuICAgIHggJiYgeFswXSAmJiBfLmdldFNldHMoeFswXSkudGhlbihyZXM9PntcbiAgICAgIHJlcy5kYXRhLmZvckVhY2goc2V0PT4ge1xuICAgICAgICBzZXQudGVybXMuZm9yRWFjaCh0ZXJtID0+IHtcbiAgICAgICAgICB0ZXJtLnNlbGVjdGVkID0gdHJ1ZVxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0gPSBsby5hc3NpZ24oe30sdGVybSlcbiAgICAgICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdLnNldElkID0gc2V0LmlkXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXS50aW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KVxuICB9XG4gIF8uZ2V0VGVybXMgPSAocmVwbGFjZSk9PiB7XG4gICAgXy5kZWNrcyA9ICEhcmVwbGFjZSA/IHt9IDogKF8uZGVja3MgfHwge30pXG4gICAgXy5ibG9vbSA9ICEhcmVwbGFjZSA/IG5ldyBCbG9vbUZpbHRlcigzZTUsIDNlLTUpIDogKF8uYmxvb20gfHwgbmV3IEJsb29tRmlsdGVyKDNlNSwgM2UtNSkpXG4gICAgXy5zZWFyY2guc3BsaXQoJywnKS5mb3JFYWNoKHRlcm09PiB7XG4gICAgICBfLmdldFNldHNmb3JUZXJtKHRlcm0udHJpbSgpKS50aGVuKGRhdGE9PiB7XG4gICAgICAgIF8uZ2V0U2V0cyhkYXRhLmRhdGEuc2V0cy5tYXAoYT0+YS5pZCkuam9pbignLCcpKVxuICAgICAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICByZXMuZGF0YS5mb3JFYWNoKHNldD0+IHtcbiAgICAgICAgICAgICAgdmFyIHRlcm1zID0gbG8uZmlsdGVyKHNldC50ZXJtcywgY2FyZD0+IHtcbiAgICAgICAgICAgICAgICBpZiAoXy5ibG9vbS50ZXN0KGNhcmQudGVybSArIGNhcmQuZGVmaW5pdGlvbikpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBfLmJsb29tLmFkZChjYXJkLnRlcm0gKyBjYXJkLmRlZmluaXRpb24pXG4gICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgdGVybXMuZm9yRWFjaCgodCxpKSA9PiB0LnJhbmsgPSBpKVxuICAgICAgICAgICAgICBpZiAodGVybXMubGVuZ3RoID4gMil7XG4gICAgICAgICAgICAgICAgXy5kZWNrc1tzZXQuaWRdID0gbG8ucGljayhzZXQsIFsndXJsJywgJ3RpdGxlJywgJ21vZGlmaWVkX2RhdGUnLCAnbGFuZ190ZXJtcycsICdsYW5nX2RlZmluaXRpb25zJ10pXG4gICAgICAgICAgICAgICAgXy5kZWNrc1tzZXQuaWRdLnRlcm1zID0gdGVybXNcbiAgICAgICAgICAgICAgICBfLmRlY2tzW3NldC5pZF0udGVybXNfbGVuZ3RoID0gdGVybXMubGVuZ3RoXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2UuZGVja3MgPSBKU09OLnN0cmluZ2lmeShfLmRlY2tzKVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH1cbn1dKVxuIl19
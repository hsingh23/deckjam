'use strict';
"use babel";

if (location.protocol != 'http:') {
  location.protocol = 'http:';
}
// if ('serviceWorker' in navigator) {
//   navigator.serviceWorker.register('service-worker.js');
// }
// removed service workers and fetch because quizlet does not do cors http://stackoverflow.com/a/34940074 
// no-cors mode won't send authorization header https://developer.mozilla.org/en-US/docs/Web/API/Request/mode
var lo = _;
// var app = angular.module('deckjam', ['ngMaterial'])
var app = angular.module('deckjam', ['ngMaterial', 'angulartics', 'angulartics.google.analytics']).config(function ($mdThemingProvider) {
  var customBlueMap = $mdThemingProvider.extendPalette('light-blue', {
    'contrastDefaultColor': 'light',
    'contrastDarkColors': ['50'],
    '50': 'ffffff'
  });
  $mdThemingProvider.definePalette('customBlue', customBlueMap);
  $mdThemingProvider.theme('default').primaryPalette('customBlue', {
    'default': '500',
    'hue-1': '50'
  }).accentPalette('pink');
  $mdThemingProvider.theme('input', 'default').primaryPalette('grey');
}).directive('iconText', function ($mdMedia) {
  return {
    restrict: 'E',
    scope: {
      tip: '@',
      icon: '@',
      style: '@?'
    },
    template: '<md-tooltip style="{{style}}" hide-gt-xs="hide-gt-xs">\n      {{tip}}\n    </md-tooltip>\n    <md-icon hide-gt-xs="hide-gt-xs" class="material-icons" style="{{style}}">\n      {{icon}}\n    </md-icon>\n    <span style="{{style}}" hide-xs>{{tip}}</span>'
  };
}).directive('loseFocus', function () {
  return {
    link: function link(scope, element, attrs) {
      scope.$watch(attrs.loseFocus, function (value) {
        if (value === true) {
          element[0].blur();
        }
      });
    }
  };
}).controller('homeContainer', ["$scope", "$http", "$mdToast", "$mdMedia", function (_, $http, $mdToast, $mdMedia) {
  _.api = 'http://ayudh.org:3337';
  _.losefocus = false;
  // _.api = 'http://localhost:3337'
  _.createdOne = localStorage.createdOne && parseInt(localStorage.createdOne) || 0;
  _.fetching = false;
  _.getSetsforTerm = function (term) {
    return $http.get(_.api + '/quizlet/search?query=' + term, { cache: true });
  };
  _.getSets = function (sets) {
    return $http.get(_.api + '/quizlet/sets?query=' + sets, { cache: true });
  };
  _.decks = JSON.parse(localStorage.decks || '{}');
  _.selected = JSON.parse(localStorage.selected || '{}');
  _.selectedOrder = "time";
  _.reverse = true;
  _.md = false;
  _.searched = "";
  _.numSelected = function () {
    return lo.size(_.selected);
  };
  _.numDecks = function () {
    return lo.size(_.decks);
  };
  _.selectedArray = function () {
    return lo.values(_.selected);
  };
  _.startIndexes = {};
  if (_.numSelected() > 0) {
    $mdToast.showSimple('You have ' + _.numSelected() + ' cards selected. Remember to clear them if you are making a new set.');
  }
  function selectTerm(term, setId) {
    if (term.selected) {
      _.selected[term.id] = lo.assign({}, term);
      _.selected[term.id].setId = setId;
      _.selected[term.id].time = new Date().getTime();
    } else {
      delete _.selected[term.id];
    }
    localStorage.selected = JSON.stringify(_.selected);
  }
  _.selectClickTerm = function (term, setId) {
    // checkbox check for tablet and below
    if (!$mdMedia('gt-md')) {
      term.selected = !term.selected;
      selectTerm(term, setId);
    }
  };
  _.selectDragTerm = function (term, setId) {
    var mouseDown = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;

    // drag anywhere for above that
    if ($mdMedia('gt-md')) {
      term.selected = mouseDown ? !term.selected : term.selected;
      selectTerm(term, setId);
    }
  };
  _.removeDeck = function (id) {
    return delete _.decks[id];
  };
  _.selectAll = function (id) {
    if (_.decks[id]) {
      // some unselected, then select all
      if (_.decks[id].terms.find(function (x) {
        return !x.selected;
      })) {
        _.decks[id].terms.forEach(function (term) {
          term.selected = true;
          _.selected[term.id] = lo.assign({}, term);
          _.selected[term.id].setId = id;
          _.selected[term.id].time = new Date().getTime();
        });
      } else {
        // unselect everything
        _.decks[id].terms.forEach(function (term) {
          term.selected = false;
          delete _.selected[term.id];
        });
      }
      localStorage.selected = JSON.stringify(_.selected);
    }
  };
  _.clearSelected = function () {
    _.selected = {};
    localStorage.selected = '{}';
  };
  _.swapSelected = function (id) {
    var _$selected$id = _.selected[id],
        term = _$selected$id.term,
        definition = _$selected$id.definition;

    _.selected[id].definition = term;
    _.selected[id].term = definition;
    localStorage.selected = JSON.stringify(_.selected);
  };
  _.removeSelected = function (id) {
    var _$selected$id2 = _.selected[id],
        setId = _$selected$id2.setId,
        rank = _$selected$id2.rank;

    if (_.decks[setId]) {
      _.decks[setId].terms[rank].selected = false;
    }
    delete _.selected[id];
    localStorage.selected = JSON.stringify(_.selected);
  };
  _.create = function (title) {
    _.url = null;
    _.creating = true;
    $http({
      method: 'POST',
      url: _.api + '/create-set',
      data: JSON.stringify({
        title: title,
        lang_terms: 'en',
        lang_definitions: 'en',
        data: lo.map(_.selected, function (v, k) {
          return lo.pick(v, ['term', 'definition', 'image']);
        })
      })
    }).then(function (res) {
      _.url = 'https://quizlet.com' + res.data.url;
      _.creating = false;
      if (res.data.error) {
        $mdToast.showSimple(res.data.error);
      } else {
        $mdToast.showSimple("Your deck is created");
        _.createdOne += 1;
        localStorage.createdOne = _.createdOne;
        _.selected_actions = 'home';
      }
    }).catch(function () {
      _.creating = false;
      _.selected_actions = 'home';
      $mdToast.showSimple("Unable to create deck");
    });
  };
  _.import = function (importUrl) {
    _.fetching = true;
    var x = importUrl && importUrl.match(/\d+/);
    x && x[0] && _.getSets(x[0]).then(function (res) {
      _.fetching = false;
      _.selected_actions = 'home';
      res.data.forEach(function (set) {
        set.terms.forEach(function (term) {
          term.selected = true;
          _.selected[term.id] = lo.assign({}, term);
          _.selected[term.id].setId = set.id;
          _.selected[term.id].time = new Date().getTime();
        });
      });
    }).catch(function () {
      _.fetching = false;
      _.selected_actions = 'home';
    });
    localStorage.selected = JSON.stringify(_.selected);
  };
  function getSets(setIds) {
    _.getSets(setIds.map(function (a) {
      return a.id;
    }).join(',')).then(function (res) {
      res.data.forEach(function (set) {
        var terms = lo.filter(set.terms, function (card) {
          if (_.bloom.test(card.term + card.definition)) {
            return false;
          } else {
            _.bloom.add(card.term + card.definition);
            return true;
          }
        });
        terms.forEach(function (t, i) {
          return t.rank = i;
        });
        if (terms.length > 2) {
          _.decks[set.id] = lo.pick(set, ['url', 'title', 'modified_date', 'lang_terms', 'lang_definitions']);
          _.decks[set.id].terms = terms;
          _.decks[set.id].terms_length = terms.length;
        }
      });
      _.fetching = false;
      _.selectedIndex = 0;
      localStorage.decks = JSON.stringify(_.decks);
      $mdToast.showSimple(_.numDecks() + " Quizlet decks loaded. Click the checkbox to choose a card.");
    }).catch(function () {
      _.fetching = false;
      $mdToast.showSimple("Unable to get terms - try another query");
    });
  }
  _.getTerms = function () {
    var replace = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;
    var replaceBloom = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

    _.losefocus = true;
    var startIndex = 0;
    _.fetching = true;
    _.decks = !!replace ? {} : _.decks || {};
    _.bloom = !!replaceBloom ? new BloomFilter(3e5, 3e-5) : _.bloom || new BloomFilter(3e5, 3e-5);
    var term = _.search.trim();
    if (term.length > 2) {
      _.searched = term;
      _.getSetsforTerm(term.trim()).then(function (res) {
        _.startIndexes[term] = _.startIndexes[term] || 0;
        startIndex = _.startIndexes[term];
        getSets(res.data.sets.slice(startIndex, startIndex + 10));
        _.startIndexes[term] = _.startIndexes[term] + 10;
      }).catch(function () {
        _.fetching = false;
        $mdToast.showSimple("Unable to get terms - try another query");
      });
    }
  };
}]);

//# sourceMappingURL=data:application/json;base64,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R0FBYSxJQUFiO0FBQ0EsTUFBRSxLQUFGLEdBQVUsQ0FBQyxDQUFDLE9BQUYsR0FBWSxFQUFaLEdBQWtCLEVBQUUsS0FBRixJQUFXLEVBQXZDO0FBQ0EsTUFBRSxLQUFGLEdBQVUsQ0FBQyxDQUFDLFlBQUYsR0FBaUIsSUFBSSxXQUFKLENBQWdCLEdBQWhCLEVBQXFCLElBQXJCLENBQWpCLEdBQStDLEVBQUUsS0FBRixJQUFXLElBQUksV0FBSixDQUFnQixHQUFoQixFQUFxQixJQUFyQixDQUFwRTtBQUNBLFFBQUksT0FBTyxFQUFFLE1BQUYsQ0FBUyxJQUFULEVBQVg7QUFDQSxRQUFHLEtBQUssTUFBTCxHQUFjLENBQWpCLEVBQW1CO0FBQ2pCLFFBQUUsUUFBRixHQUFhLElBQWI7QUFDQSxRQUFFLGNBQUYsQ0FBaUIsS0FBSyxJQUFMLEVBQWpCLEVBQThCLElBQTlCLENBQW1DLGVBQU07QUFDdkMsVUFBRSxZQUFGLENBQWUsSUFBZixJQUF1QixFQUFFLFlBQUYsQ0FBZSxJQUFmLEtBQXdCLENBQS9DO0FBQ0EscUJBQWEsRUFBRSxZQUFGLENBQWUsSUFBZixDQUFiO0FBQ0EsZ0JBQVEsSUFBSSxJQUFKLENBQVMsSUFBVCxDQUFjLEtBQWQsQ0FBb0IsVUFBcEIsRUFBK0IsYUFBVyxFQUExQyxDQUFSO0FBQ0EsVUFBRSxZQUFGLENBQWUsSUFBZixJQUF1QixFQUFFLFlBQUYsQ0FBZSxJQUFmLElBQXVCLEVBQTlDO0FBQ0QsT0FMRCxFQU1DLEtBTkQsQ0FNTyxZQUFJO0FBQ1QsVUFBRSxRQUFGLEdBQWEsS0FBYjtBQUNBLGlCQUFTLFVBQVQsQ0FBb0IseUNBQXBCO0FBQ0QsT0FURDtBQVVEO0FBQ0YsR0FwQkQ7QUFxQkQsQ0F0TDRCLENBN0NuQixDQUFWIiwiZmlsZSI6ImFwcC5wcm9kLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2UgYmFiZWxcIjtcbmlmIChsb2NhdGlvbi5wcm90b2NvbCAhPSAnaHR0cDonKSB7XG4gIGxvY2F0aW9uLnByb3RvY29sID0gJ2h0dHA6Jztcbn1cbi8vIGlmICgnc2VydmljZVdvcmtlcicgaW4gbmF2aWdhdG9yKSB7XG4vLyAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlZ2lzdGVyKCdzZXJ2aWNlLXdvcmtlci5qcycpO1xuLy8gfVxuLy8gcmVtb3ZlZCBzZXJ2aWNlIHdvcmtlcnMgYW5kIGZldGNoIGJlY2F1c2UgcXVpemxldCBkb2VzIG5vdCBkbyBjb3JzIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzM0OTQwMDc0IFxuLy8gbm8tY29ycyBtb2RlIHdvbid0IHNlbmQgYXV0aG9yaXphdGlvbiBoZWFkZXIgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1JlcXVlc3QvbW9kZVxudmFyIGxvID0gXztcbi8vIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZGVja2phbScsIFsnbmdNYXRlcmlhbCddKVxudmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdkZWNramFtJywgWyduZ01hdGVyaWFsJywgJ2FuZ3VsYXJ0aWNzJywgJ2FuZ3VsYXJ0aWNzLmdvb2dsZS5hbmFseXRpY3MnXSlcbi5jb25maWcoZnVuY3Rpb24oJG1kVGhlbWluZ1Byb3ZpZGVyKSB7XG4gIHZhciBjdXN0b21CbHVlTWFwID0gJG1kVGhlbWluZ1Byb3ZpZGVyLmV4dGVuZFBhbGV0dGUoJ2xpZ2h0LWJsdWUnLCB7XG4gICAgJ2NvbnRyYXN0RGVmYXVsdENvbG9yJzogJ2xpZ2h0JyxcbiAgICAnY29udHJhc3REYXJrQ29sb3JzJzogWyc1MCddLFxuICAgICc1MCc6ICdmZmZmZmYnXG4gIH0pXG4gICRtZFRoZW1pbmdQcm92aWRlci5kZWZpbmVQYWxldHRlKCdjdXN0b21CbHVlJywgY3VzdG9tQmx1ZU1hcClcbiAgJG1kVGhlbWluZ1Byb3ZpZGVyLnRoZW1lKCdkZWZhdWx0JylcbiAgICAucHJpbWFyeVBhbGV0dGUoJ2N1c3RvbUJsdWUnLCB7XG4gICAgICAnZGVmYXVsdCc6ICc1MDAnLFxuICAgICAgJ2h1ZS0xJzogJzUwJ1xuICAgIH0pXG4gICAgLmFjY2VudFBhbGV0dGUoJ3BpbmsnKVxuICAkbWRUaGVtaW5nUHJvdmlkZXIudGhlbWUoJ2lucHV0JywgJ2RlZmF1bHQnKVxuICAgIC5wcmltYXJ5UGFsZXR0ZSgnZ3JleScpXG59KVxuLmRpcmVjdGl2ZSgnaWNvblRleHQnLCBmdW5jdGlvbigkbWRNZWRpYSkge1xuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnRScsXG4gICAgc2NvcGU6IHtcbiAgICAgIHRpcDogJ0AnLFxuICAgICAgaWNvbjogJ0AnLFxuICAgICAgc3R5bGU6ICdAPydcbiAgICB9LFxuICAgIHRlbXBsYXRlOiBgPG1kLXRvb2x0aXAgc3R5bGU9XCJ7e3N0eWxlfX1cIiBoaWRlLWd0LXhzPVwiaGlkZS1ndC14c1wiPlxuICAgICAge3t0aXB9fVxuICAgIDwvbWQtdG9vbHRpcD5cbiAgICA8bWQtaWNvbiBoaWRlLWd0LXhzPVwiaGlkZS1ndC14c1wiIGNsYXNzPVwibWF0ZXJpYWwtaWNvbnNcIiBzdHlsZT1cInt7c3R5bGV9fVwiPlxuICAgICAge3tpY29ufX1cbiAgICA8L21kLWljb24+XG4gICAgPHNwYW4gc3R5bGU9XCJ7e3N0eWxlfX1cIiBoaWRlLXhzPnt7dGlwfX08L3NwYW4+YFxuICB9XG59KVxuLmRpcmVjdGl2ZSgnbG9zZUZvY3VzJywgZnVuY3Rpb24oKSB7XG4gIHJldHVybiB7XG4gICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7XG4gICAgICBzY29wZS4kd2F0Y2goYXR0cnMubG9zZUZvY3VzLCBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICBpZih2YWx1ZSA9PT0gdHJ1ZSkge1xuICAgICAgICAgIGVsZW1lbnRbMF0uYmx1cigpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9XG59KVxuLmNvbnRyb2xsZXIoJ2hvbWVDb250YWluZXInLCBbXCIkc2NvcGVcIiwgXCIkaHR0cFwiLCBcIiRtZFRvYXN0XCIsIFwiJG1kTWVkaWFcIiAsKF8sICRodHRwLCAkbWRUb2FzdCwgJG1kTWVkaWEpPT4ge1xuICBfLmFwaSA9ICdodHRwOi8vYXl1ZGgub3JnOjMzMzcnXG4gIF8ubG9zZWZvY3VzID0gZmFsc2VcbiAgLy8gXy5hcGkgPSAnaHR0cDovL2xvY2FsaG9zdDozMzM3J1xuICBfLmNyZWF0ZWRPbmUgPSBsb2NhbFN0b3JhZ2UuY3JlYXRlZE9uZSAmJiBwYXJzZUludChsb2NhbFN0b3JhZ2UuY3JlYXRlZE9uZSkgfHwgMFxuICBfLmZldGNoaW5nID0gZmFsc2VcbiAgXy5nZXRTZXRzZm9yVGVybSA9ICh0ZXJtKT0+ICRodHRwLmdldChgJHtfLmFwaX0vcXVpemxldC9zZWFyY2g/cXVlcnk9JHt0ZXJtfWAsIHsgY2FjaGU6IHRydWV9KVxuICBfLmdldFNldHMgPSAoc2V0cyk9PiAkaHR0cC5nZXQoYCR7Xy5hcGl9L3F1aXpsZXQvc2V0cz9xdWVyeT0ke3NldHN9YCwgeyBjYWNoZTogdHJ1ZX0pXG4gIF8uZGVja3MgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5kZWNrcyB8fCAne30nKVxuICBfLnNlbGVjdGVkID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgfHwgJ3t9JylcbiAgXy5zZWxlY3RlZE9yZGVyID0gXCJ0aW1lXCJcbiAgXy5yZXZlcnNlID0gdHJ1ZVxuICBfLm1kID0gZmFsc2VcbiAgXy5zZWFyY2hlZCA9IFwiXCJcbiAgXy5udW1TZWxlY3RlZCA9ICgpPT4gbG8uc2l6ZShfLnNlbGVjdGVkKVxuICBfLm51bURlY2tzID0gKCk9PiBsby5zaXplKF8uZGVja3MpXG4gIF8uc2VsZWN0ZWRBcnJheSA9ICgpPT4gbG8udmFsdWVzKF8uc2VsZWN0ZWQpXG4gIF8uc3RhcnRJbmRleGVzID0ge31cbiAgaWYoXy5udW1TZWxlY3RlZCgpID4gMCl7XG4gICAgJG1kVG9hc3Quc2hvd1NpbXBsZShgWW91IGhhdmUgJHtfLm51bVNlbGVjdGVkKCl9IGNhcmRzIHNlbGVjdGVkLiBSZW1lbWJlciB0byBjbGVhciB0aGVtIGlmIHlvdSBhcmUgbWFraW5nIGEgbmV3IHNldC5gKVxuICB9XG4gIGZ1bmN0aW9uIHNlbGVjdFRlcm0odGVybSwgc2V0SWQpIHtcbiAgICBpZiAodGVybS5zZWxlY3RlZCkge1xuICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXSA9IGxvLmFzc2lnbih7fSx0ZXJtKVxuICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXS5zZXRJZCA9IHNldElkXG4gICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdLnRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGRlbGV0ZSBfLnNlbGVjdGVkW3Rlcm0uaWRdXG4gICAgfVxuICAgIGxvY2FsU3RvcmFnZS5zZWxlY3RlZCA9IEpTT04uc3RyaW5naWZ5KF8uc2VsZWN0ZWQpXG4gIH1cbiAgXy5zZWxlY3RDbGlja1Rlcm0gPSAodGVybSwgc2V0SWQpID0+IHtcbiAgICAvLyBjaGVja2JveCBjaGVjayBmb3IgdGFibGV0IGFuZCBiZWxvd1xuICAgIGlmKCEkbWRNZWRpYSgnZ3QtbWQnKSkge1xuICAgICAgdGVybS5zZWxlY3RlZCA9ICF0ZXJtLnNlbGVjdGVkXG4gICAgICBzZWxlY3RUZXJtKHRlcm0sIHNldElkKVxuICAgIH1cbiAgfVxuICBfLnNlbGVjdERyYWdUZXJtID0gKHRlcm0sIHNldElkLCBtb3VzZURvd249dHJ1ZSkgPT4ge1xuICAgIC8vIGRyYWcgYW55d2hlcmUgZm9yIGFib3ZlIHRoYXRcbiAgICBpZigkbWRNZWRpYSgnZ3QtbWQnKSl7XG4gICAgICB0ZXJtLnNlbGVjdGVkID0gKG1vdXNlRG93bikgPyAhdGVybS5zZWxlY3RlZCA6IHRlcm0uc2VsZWN0ZWRcbiAgICAgIHNlbGVjdFRlcm0odGVybSwgc2V0SWQpXG4gICAgfVxuICB9XG4gIF8ucmVtb3ZlRGVjayA9IGlkPT4gZGVsZXRlIF8uZGVja3NbaWRdXG4gIF8uc2VsZWN0QWxsID0gaWQ9PiB7XG4gICAgaWYgKF8uZGVja3NbaWRdKSB7XG4gICAgICAvLyBzb21lIHVuc2VsZWN0ZWQsIHRoZW4gc2VsZWN0IGFsbFxuICAgICAgaWYgKF8uZGVja3NbaWRdLnRlcm1zLmZpbmQoeD0+ICF4LnNlbGVjdGVkKSl7XG4gICAgICAgIF8uZGVja3NbaWRdLnRlcm1zLmZvckVhY2godGVybSA9PiB7XG4gICAgICAgICAgdGVybS5zZWxlY3RlZCA9IHRydWVcbiAgICAgICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdID0gbG8uYXNzaWduKHt9LHRlcm0pXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXS5zZXRJZCA9IGlkXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXS50aW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdW5zZWxlY3QgZXZlcnl0aGluZ1xuICAgICAgICBfLmRlY2tzW2lkXS50ZXJtcy5mb3JFYWNoKHRlcm0gPT4ge1xuICAgICAgICAgIHRlcm0uc2VsZWN0ZWQgPSBmYWxzZVxuICAgICAgICAgIGRlbGV0ZSBfLnNlbGVjdGVkW3Rlcm0uaWRdXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgPSBKU09OLnN0cmluZ2lmeShfLnNlbGVjdGVkKVxuICAgIH1cbiAgfVxuICBfLmNsZWFyU2VsZWN0ZWQgPSAoKT0+IHtcbiAgICBfLnNlbGVjdGVkID0ge31cbiAgICBsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgPSAne30nXG4gIH1cbiAgXy5zd2FwU2VsZWN0ZWQgPSBpZD0+IHtcbiAgICB2YXIge3Rlcm0sIGRlZmluaXRpb259ID0gXy5zZWxlY3RlZFtpZF1cbiAgICBfLnNlbGVjdGVkW2lkXS5kZWZpbml0aW9uID0gdGVybVxuICAgIF8uc2VsZWN0ZWRbaWRdLnRlcm0gPSBkZWZpbml0aW9uXG4gICAgbG9jYWxTdG9yYWdlLnNlbGVjdGVkID0gSlNPTi5zdHJpbmdpZnkoXy5zZWxlY3RlZClcbiAgfVxuICBfLnJlbW92ZVNlbGVjdGVkID0gaWQ9PiB7XG4gICAgdmFyIHtzZXRJZCwgcmFua30gPSBfLnNlbGVjdGVkW2lkXVxuICAgIGlmKF8uZGVja3Nbc2V0SWRdKSB7XG4gICAgICBfLmRlY2tzW3NldElkXS50ZXJtc1tyYW5rXS5zZWxlY3RlZCA9IGZhbHNlXG4gICAgfVxuICAgIGRlbGV0ZSBfLnNlbGVjdGVkW2lkXVxuICAgIGxvY2FsU3RvcmFnZS5zZWxlY3RlZCA9IEpTT04uc3RyaW5naWZ5KF8uc2VsZWN0ZWQpXG4gIH1cbiAgXy5jcmVhdGUgPSAodGl0bGUpPT4ge1xuICAgIF8udXJsID0gbnVsbFxuICAgIF8uY3JlYXRpbmcgPSB0cnVlXG4gICAgJGh0dHAoe1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICB1cmw6IGAke18uYXBpfS9jcmVhdGUtc2V0YCxcbiAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgdGl0bGU6IHRpdGxlLFxuICAgICAgICBsYW5nX3Rlcm1zOiAnZW4nLFxuICAgICAgICBsYW5nX2RlZmluaXRpb25zOiAnZW4nLFxuICAgICAgICBkYXRhOiBsby5tYXAoXy5zZWxlY3RlZCwgKHYsayk9PiBsby5waWNrKHYsIFsndGVybScsICdkZWZpbml0aW9uJywgJ2ltYWdlJ10pKVxuICAgICAgfSlcbiAgICB9KS50aGVuKHJlcz0+e1xuICAgICAgXy51cmwgPSBgaHR0cHM6Ly9xdWl6bGV0LmNvbSR7cmVzLmRhdGEudXJsfWBcbiAgICAgIF8uY3JlYXRpbmcgPSBmYWxzZVxuICAgICAgaWYgKHJlcy5kYXRhLmVycm9yKSB7XG4gICAgICAgICRtZFRvYXN0LnNob3dTaW1wbGUocmVzLmRhdGEuZXJyb3IpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAkbWRUb2FzdC5zaG93U2ltcGxlKFwiWW91ciBkZWNrIGlzIGNyZWF0ZWRcIilcbiAgICAgICAgXy5jcmVhdGVkT25lICs9IDFcbiAgICAgICAgbG9jYWxTdG9yYWdlLmNyZWF0ZWRPbmUgPSBfLmNyZWF0ZWRPbmVcbiAgICAgICAgXy5zZWxlY3RlZF9hY3Rpb25zID0gJ2hvbWUnXG4gICAgICB9XG4gICAgfSkuY2F0Y2goKCk9PntcbiAgICAgIF8uY3JlYXRpbmc9ZmFsc2VcbiAgICAgIF8uc2VsZWN0ZWRfYWN0aW9ucyA9ICdob21lJ1xuICAgICAgJG1kVG9hc3Quc2hvd1NpbXBsZShcIlVuYWJsZSB0byBjcmVhdGUgZGVja1wiKVxuICAgIH0pXG4gIH1cbiAgXy5pbXBvcnQgPSAoaW1wb3J0VXJsKSA9PiB7XG4gICAgXy5mZXRjaGluZyA9IHRydWVcbiAgICB2YXIgeCA9IGltcG9ydFVybCAmJiBpbXBvcnRVcmwubWF0Y2goL1xcZCsvKVxuICAgIHggJiYgeFswXSAmJiBfLmdldFNldHMoeFswXSkudGhlbihyZXM9PntcbiAgICAgIF8uZmV0Y2hpbmcgPSBmYWxzZVxuICAgICAgXy5zZWxlY3RlZF9hY3Rpb25zID0gJ2hvbWUnXG4gICAgICByZXMuZGF0YS5mb3JFYWNoKHNldD0+IHtcbiAgICAgICAgc2V0LnRlcm1zLmZvckVhY2godGVybSA9PiB7XG4gICAgICAgICAgdGVybS5zZWxlY3RlZCA9IHRydWVcbiAgICAgICAgICBfLnNlbGVjdGVkW3Rlcm0uaWRdID0gbG8uYXNzaWduKHt9LHRlcm0pXG4gICAgICAgICAgXy5zZWxlY3RlZFt0ZXJtLmlkXS5zZXRJZCA9IHNldC5pZFxuICAgICAgICAgIF8uc2VsZWN0ZWRbdGVybS5pZF0udGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKClcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSkuY2F0Y2goKCk9PntcbiAgICAgIF8uZmV0Y2hpbmcgPSBmYWxzZVxuICAgICAgXy5zZWxlY3RlZF9hY3Rpb25zID0gJ2hvbWUnXG4gICAgfSlcbiAgICBsb2NhbFN0b3JhZ2Uuc2VsZWN0ZWQgPSBKU09OLnN0cmluZ2lmeShfLnNlbGVjdGVkKVxuICB9XG4gIGZ1bmN0aW9uIGdldFNldHMoc2V0SWRzKSB7XG4gICAgXy5nZXRTZXRzKHNldElkcy5tYXAoYT0+YS5pZCkuam9pbignLCcpKVxuICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICByZXMuZGF0YS5mb3JFYWNoKHNldD0+IHtcbiAgICAgICAgdmFyIHRlcm1zID0gbG8uZmlsdGVyKHNldC50ZXJtcywgY2FyZD0+IHtcbiAgICAgICAgICBpZiAoXy5ibG9vbS50ZXN0KGNhcmQudGVybSArIGNhcmQuZGVmaW5pdGlvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBfLmJsb29tLmFkZChjYXJkLnRlcm0gKyBjYXJkLmRlZmluaXRpb24pXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgdGVybXMuZm9yRWFjaCgodCxpKSA9PiB0LnJhbmsgPSBpKVxuICAgICAgICBpZiAodGVybXMubGVuZ3RoID4gMil7XG4gICAgICAgICAgXy5kZWNrc1tzZXQuaWRdID0gbG8ucGljayhzZXQsIFsndXJsJywgJ3RpdGxlJywgJ21vZGlmaWVkX2RhdGUnLCAnbGFuZ190ZXJtcycsICdsYW5nX2RlZmluaXRpb25zJ10pXG4gICAgICAgICAgXy5kZWNrc1tzZXQuaWRdLnRlcm1zID0gdGVybXNcbiAgICAgICAgICBfLmRlY2tzW3NldC5pZF0udGVybXNfbGVuZ3RoID0gdGVybXMubGVuZ3RoXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICBfLmZldGNoaW5nID0gZmFsc2VcbiAgICAgIF8uc2VsZWN0ZWRJbmRleD0wXG4gICAgICBsb2NhbFN0b3JhZ2UuZGVja3MgPSBKU09OLnN0cmluZ2lmeShfLmRlY2tzKVxuICAgICAgJG1kVG9hc3Quc2hvd1NpbXBsZShfLm51bURlY2tzKCkgKyBcIiBRdWl6bGV0IGRlY2tzIGxvYWRlZC4gQ2xpY2sgdGhlIGNoZWNrYm94IHRvIGNob29zZSBhIGNhcmQuXCIpXG4gICAgfSkuY2F0Y2goKCk9PntcbiAgICAgIF8uZmV0Y2hpbmcgPSBmYWxzZVxuICAgICAgJG1kVG9hc3Quc2hvd1NpbXBsZShcIlVuYWJsZSB0byBnZXQgdGVybXMgLSB0cnkgYW5vdGhlciBxdWVyeVwiKVxuICAgIH0pXG4gIH1cbiAgXy5nZXRUZXJtcyA9IChyZXBsYWNlPXRydWUsIHJlcGxhY2VCbG9vbT10cnVlKT0+IHtcbiAgICBfLmxvc2Vmb2N1cyA9IHRydWVcbiAgICB2YXIgc3RhcnRJbmRleCA9IDA7XG4gICAgXy5mZXRjaGluZyA9IHRydWVcbiAgICBfLmRlY2tzID0gISFyZXBsYWNlID8ge30gOiAoXy5kZWNrcyB8fCB7fSlcbiAgICBfLmJsb29tID0gISFyZXBsYWNlQmxvb20gPyBuZXcgQmxvb21GaWx0ZXIoM2U1LCAzZS01KSA6IChfLmJsb29tIHx8IG5ldyBCbG9vbUZpbHRlcigzZTUsIDNlLTUpKVxuICAgIHZhciB0ZXJtID0gXy5zZWFyY2gudHJpbSgpXG4gICAgaWYodGVybS5sZW5ndGggPiAyKXtcbiAgICAgIF8uc2VhcmNoZWQgPSB0ZXJtXG4gICAgICBfLmdldFNldHNmb3JUZXJtKHRlcm0udHJpbSgpKS50aGVuKHJlcz0+IHtcbiAgICAgICAgXy5zdGFydEluZGV4ZXNbdGVybV0gPSBfLnN0YXJ0SW5kZXhlc1t0ZXJtXSB8fCAwXG4gICAgICAgIHN0YXJ0SW5kZXggPSBfLnN0YXJ0SW5kZXhlc1t0ZXJtXVxuICAgICAgICBnZXRTZXRzKHJlcy5kYXRhLnNldHMuc2xpY2Uoc3RhcnRJbmRleCxzdGFydEluZGV4KzEwKSlcbiAgICAgICAgXy5zdGFydEluZGV4ZXNbdGVybV0gPSBfLnN0YXJ0SW5kZXhlc1t0ZXJtXSArIDEwXG4gICAgICB9KVxuICAgICAgLmNhdGNoKCgpPT57XG4gICAgICAgIF8uZmV0Y2hpbmcgPSBmYWxzZVxuICAgICAgICAkbWRUb2FzdC5zaG93U2ltcGxlKFwiVW5hYmxlIHRvIGdldCB0ZXJtcyAtIHRyeSBhbm90aGVyIHF1ZXJ5XCIpXG4gICAgICB9KVxuICAgIH1cbiAgfVxufV0pXG4iXX0=